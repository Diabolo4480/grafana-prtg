{"version":3,"sources":["../src/query_ctrl.js"],"names":["getMetricNames","scope","metricList","_","uniq","map","metric","QueryCtrl","PRTGQueryController","$scope","$injector","$sce","$q","templateSrv","init","target","targetLetters","scopeDefaults","oldTarget","cloneDeep","defaults","updateGroupList","updateDeviceList","updateSensorList","updateChannelList","errors","validateTarget","getGroupNames","partial","getDeviceNames","getSensorNames","getChannelNames","alias","device","name","sensor","channel","newTarget","isEqual","panelCtrl","refresh","targetChange","setTargetAlias","groupList","visible_name","addTemplatedVariables","datasource","prtgAPI","performGroupSuggestQuery","then","groups","push","group","deviceList","undefined","replace","performDeviceSuggestQuery","devices","sensorList","performSensorSuggestQuery","sensors","channelList","performChannelSuggestQuery","channels","each","variables","variable","templated","errs","templateUrl"],"mappings":"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","file":"query_ctrl.js","sourcesContent":["/**\r\n * Grafana Datasource Plugin for PRTG API Interface (ALPHA)\r\n * Query Control Interface\r\n * 20170218 Jason Lashua\r\n *\r\n * Updated for es6\r\n */\r\n\r\nimport {QueryCtrl} from 'app/plugins/sdk';\r\nimport _ from 'lodash';\r\n\r\nexport class PRTGQueryController extends QueryCtrl {\r\n\r\n  constructor($scope, $injector, $sce, $q, templateSrv) {\r\n    super($scope, $injector);\r\n    this.init = function() {\r\n      var target = this.target;\r\n      this.templateSrv = templateSrv;\r\n      this.targetLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';\r\n      var scopeDefaults = {\r\n        metric: {},\r\n        oldTarget: _.cloneDeep(this.target)\r\n      };\r\n      _.defaults(this, scopeDefaults);\r\n      \r\n      this.updateGroupList();\r\n      this.updateDeviceList();\r\n      this.updateSensorList();\r\n      this.updateChannelList();\r\n\r\n      this.target.errors = this.validateTarget(target);\r\n    \r\n      //the zabbix-grafana guys are way more smarter than i am, brilliant idea.      \r\n      this.getGroupNames = _.partial(getMetricNames, this, 'groupList');\r\n      this.getDeviceNames = _.partial(getMetricNames, this, 'deviceList');\r\n      this.getSensorNames = _.partial(getMetricNames, this, 'sensorList');\r\n      this.getChannelNames = _.partial(getMetricNames, this, 'channelList');\r\n    };\r\n    this.init();\r\n  }\r\n  \r\n  /**\r\n  * Alias is comprised of the device name, sensor and channel, e.g., FILESERV1: DNS Response Time.\r\n  */\r\n  setTargetAlias() {\r\n    this.target.alias = this.target.device.name + \": \" + this.target.sensor.name + \" \" + this.target.channel.name;\r\n  }\r\n  \r\n  // take action on target update and refresh the model? whatever the hell angular actually does is beyond me... \r\n  targetChange() {\r\n    var newTarget = _.cloneDeep(this.target);\r\n    if (!_.isEqual(this.oldTarget, this.target)) {\r\n      this.oldTarget = newTarget;\r\n      this.panelCtrl.refresh();\r\n    }\r\n  }\r\n\r\n  /*\r\n   * Select functions: when a object is selected or typed into the input,\r\n   * refresh the next list based on the data entered in the previous input.\r\n   * This is all necessary because the only way to get values from PRTG is by knowing a sensor ID\r\n   * So we basically perform a single object search, one peice at a time, then we know the sensor ID, and the channel name can be picked.\r\n   */\r\n  selectGroup() {\r\n    this.updateDeviceList();\r\n    this.targetChange();\r\n  }\r\n  \r\n  selectDevice() {\r\n    this.updateSensorList();\r\n    this.targetChange();\r\n  }\r\n  \r\n  selectSensor() {\r\n    this.updateChannelList();\r\n    this.targetChange();\r\n  }\r\n  \r\n  selectChannel() {\r\n    this.setTargetAlias();\r\n    this.targetChange();\r\n  }\r\n  \r\n  /*\r\n   * Update the content of each list\r\n  */   \r\n  updateGroupList() {\r\n    this.metric.groupList = [{name: '*', visible_name: 'All'}];\r\n    this.addTemplatedVariables(this.metric.groupList);\r\n    this.datasource.prtgAPI.performGroupSuggestQuery().then(groups => {\r\n      _.map(groups, group => { \r\n        this.metric.groupList.push({name: group.group, visible_name: group.group});\r\n      });\r\n    });\r\n  }\r\n  \r\n  updateDeviceList() {\r\n    var group;\r\n    this.metric.deviceList = [{name: '*', visible_name: 'All'}];\r\n    this.addTemplatedVariables(this.metric.deviceList);\r\n    if (this.target.group) {\r\n      group = this.target.group.name || undefined;\r\n      group = this.templateSrv.replace(group);\r\n    }\r\n    this.datasource.prtgAPI.performDeviceSuggestQuery(group).then(devices => {\r\n      _.map(devices, device => {\r\n        this.metric.deviceList.push({name: device.device, visible_name: device.device});\r\n      });\r\n    });\r\n  }\r\n\r\n  updateSensorList() {\r\n    var device;\r\n    this.metric.sensorList = [{name: '*', visible_name: 'All'}];\r\n    this.addTemplatedVariables(this.metric.sensorList);\r\n    if (this.target.device) {\r\n      device = this.target.device.name || undefined;\r\n      device = this.templateSrv.replace(device);\r\n    }\r\n    this.datasource.prtgAPI.performSensorSuggestQuery(device).then(sensors => {\r\n      _.map(sensors, sensor => {\r\n        this.metric.sensorList.push({name: sensor.sensor, visible_name: sensor.sensor});\r\n      });\r\n    });\r\n  }\r\n\r\n  updateChannelList() {\r\n    var sensor, device;\r\n    this.metric.channelList = [{name: '*', visible_name: 'All'},{name: '!', visible_name: 'Last Message'}];\r\n    this.addTemplatedVariables(this.metric.channelList);\r\n    if (this.target.sensor) {\r\n      sensor = this.target.sensor.name;\r\n      sensor = this.templateSrv.replace(sensor);\r\n      device = this.templateSrv.replace(this.target.device.name);\r\n      this.datasource.prtgAPI.performChannelSuggestQuery(sensor, device).then(channels => {\r\n        _.map(channels, channel => {\r\n          this.metric.channelList.push({name: channel.name, visible_name: channel.name});\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n  * Add templated variables to list of available metrics\r\n  *\r\n  * @param {Array} metricList List of metrics which variables add to\r\n  */\r\n  addTemplatedVariables(metricList) {\r\n    _.each(this.templateSrv.variables, function(variable) {\r\n      metricList.push({\r\n        name: '$' + variable.name,\r\n        templated: true\r\n      });\r\n    });\r\n  }\r\n\r\n  // just validate the target exists for now.\r\n  validateTarget(target) {\r\n    var errs = {};\r\n    if (!target) {\r\n      errs = 'Not defined';\r\n    }\r\n    return errs;\r\n  }\r\n}\r\n\r\n// Set templateUrl as static property\r\nPRTGQueryController.templateUrl = './partials/query.editor.html';\r\n\r\n// I stole this from grafana-zabbix, err, I mean, I was inspired by grafana-zabbix ;) \r\nfunction getMetricNames(scope, metricList) {  \r\n  return _.uniq(_.map(scope.metric[metricList], 'name'));\r\n}\r\n"]}