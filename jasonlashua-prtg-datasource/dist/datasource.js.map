{"version":3,"sources":["../src/datasource.js"],"names":["_","dateMath","PRTGDataSource","instanceSettings","templateSrv","alertSrv","PRTGAPIService","alertServ","name","url","username","jsonData","prtgApiUser","passhash","prtgApiPasshash","cacheTimeoutMintues","cacheTimeoutMinutes","limitmetrics","meta","prtgAPI","getVersion","then","performPRTGAPILogin","status","title","message","apiVersion","console","log","JSON","stringify","error","statusText","options","from","Math","ceil","parse","range","to","promises","map","targets","target","cloneDeep","t","hide","group","device","channel","sensor","replace","scopedVars","getItemsFromTarget","devices","uniq","items","promise","getItemHistory","item","alias","keys","length","timeseries","datapoints","values","Promise","all","flatten","data","results","getMessages","annotation","sensorId","each","messages","query","params","a","split","b","performPRTGAPIRequest","text","res","expandable"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from 'lodash';\nimport * as dateMath from 'app/core/utils/datemath';\nimport './PRTGAPIService';\n\nclass PRTGDataSource {\n    \n    /** @ngInject */\n    constructor(instanceSettings, templateSrv, alertSrv, PRTGAPIService) {\n        /**\n        * PRTG Datasource\n        * \n        * @param {object} Grafana Datasource Object\n        */\n        this.templateSrv = templateSrv;\n        this.alertServ = alertSrv;\n        \n        this.name =     instanceSettings.name;\n        this.url =      instanceSettings.url;\n        this.username = instanceSettings.jsonData.prtgApiUser;\n        this.passhash = instanceSettings.jsonData.prtgApiPasshash;\n        this.cacheTimeoutMintues = instanceSettings.jsonData.cacheTimeoutMinutes || 5;\n        this.limitmetrics = instanceSettings.meta.limitmetrics || 100;\n        this.prtgAPI = new PRTGAPIService(this.url, this.username, this.passhash, this.cacheTimeoutMintues);\n    }\n\n        /**\n         * Test the datasource\n         */\n        testDatasource() {\n            return this.prtgAPI.getVersion().then(apiVersion => {\n                return this.prtgAPI.performPRTGAPILogin()\n                    .then(() => {\n                        return {\n                            status: \"success\",\n                            title: \"Success\",\n                            message: \"PRTG API version: \" + apiVersion\n                        };\n                });\n            }, error => {\n                console.log(JSON.stringify(error,null,4));\n                return {\n                    status: \"error\",\n                    title: error.status + \": \" + error.statusText,\n                    message: \"\"//error.config.url\n                };\n            });\n        }\n    \n        \n        /**\n         * Data Source Query\n         * returns timeseries array of values\n         * \n         * @param {object} options; Dataset Options including targets, etc.\n         * @return [array]\n         */\n        query(options) {\n            var from = Math.ceil(dateMath.parse(options.range.from) / 1000);\n            var to = Math.ceil(dateMath.parse(options.range.to) / 1000);\n            \n            var promises = _.map(options.targets, t => {\n                var target = _.cloneDeep(t);    \n                if (target.hide || !target.group || !target.device || !target.channel || !target.sensor) {\n                    return [];\n                }\n                \n                var device, group, sensor, channel = \"\";\n                group    = this.templateSrv.replace(target.group.name, options.scopedVars);\n                device   = this.templateSrv.replace(target.device.name, options.scopedVars);\n                sensor   = this.templateSrv.replace(target.sensor.name, options.scopedVars);\n                channel  = this.templateSrv.replace(target.channel.name, options.scopedVars);\n                if (group === '*') { group = \"/.*/\";}\n                if (device === '*') { device = \"/.*/\";}\n                if (sensor === '*') { sensor = \"/.*/\";}\n                if (channel === '*') { channel = \"/.*/\";}\n                //oh isn't that just crappy? works for now!\n\n                return this.prtgAPI.getItemsFromTarget(target)\n                    .then(items => {\n                        var devices = _.uniq(_.map(items, 'device'));\n                        console.log('devices: ' + JSON.stringify(devices,'',4));\n                         var promise = _.map(items, item => {\n                            return this.prtgAPI.getItemHistory(item.sensor, item.name, from, to).then(values => {\n                                var alias = item.name;\n                                if (_.keys(devices).length > 1) {\n                                    alias = item.device + ': ' + alias;\n                                }\n                                var timeseries = {target:alias, datapoints: values};\n                                return timeseries;\n                            });\n                        });\n                        return Promise.all(promise).then(_.flatten);\n                    });\n            });\n            \n            return Promise.all(_.flatten(promises))\n                .then(results => {\n                    return {data: _.flatten(results)};\n                });\n        }\n        \n       annotationQuery (options) {\n            var from = Math.ceil(dateMath.parse(options.range.from) / 1000);\n            var to = Math.ceil(dateMath.parse(options.range.to) / 1000);\n            return this.prtgAPI.getMessages(from, to, options.annotation.sensorId)\n                .then(messages => {\n                    _.each(messages, message => {\n                        message.annotation = options.annotation; //inject the annotation into the object\n                    }, this);\n                return messages;\n            });\n        }\n\n        /* Find Metrics from templated letiables\n         *\n         * channel templates are limited to lookup by sensor's numeric ID.\n         *\n         * @param query Query string:\n         * channel:sensor=####\n         * sensor:device=$device or * or numeric ID\n         * device:group=$group or * or numeric ID\n         * group:* or name\n         */\n        metricFindQuery (query) {\n            //if (!query.match(/(channel|sensor|device|group):(\\*)|(tags|sensor|device|group)=([\\$\\sa-zA-Z0-9-_]+)/i)) {\n            //    return Promise.reject(\"Syntax Error: Expected pattern matching /(sensors|devices|groups):(\\*)|(tags|device|group)=([a-zA-Z0-9]+)/i\");\n           // }\n        \n            // sensor:device=$server\n            // item   type   value\n            \n            //group.host.sensor.channel\n            //*.$host.\n            console.log(\"Metricfindquery: \" + query);\n            var params = \"\";\n            var a = query.split(':');\n            var b;\n            if (a[1] !== '*') {\n                b = a[1].split('=');\n            }\n            if (a[0] == \"channel\") {\n                params = \"&content=channels&columns=name&id=\" + this.templateSrv.replace(b[1]);\n                //a[0]=\"name\";\n            } else {\n                params=\"&content=\" + a[0] + \"s&count=9999\";\n                if (a[1] !== '*') {\n                    params = params + \"&filter_\" + this.templateSrv.replace(a[1]);\n                }\n            }\n            return this.prtgAPI.performPRTGAPIRequest('table.json', params)\n                .then(results => {\n                    \n                    return _.map(results, res => {\n                        return {text: res[a[0]], expandable:0};\n                    }, this);\n            });\n            \n        }\n\n \n}\n\nexport { PRTGDataSource };\n\n"]}