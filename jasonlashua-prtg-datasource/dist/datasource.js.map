{"version":3,"sources":["../src/datasource.js"],"names":["_","dateMath","PRTGDataSource","instanceSettings","templateSrv","alertSrv","PRTGAPIService","alertServ","name","url","username","jsonData","prtgApiUser","passhash","prtgApiPasshash","cacheTimeoutMintues","cacheTimeoutMinutes","limitmetrics","meta","prtgAPI","getVersion","then","performPRTGAPILogin","status","title","message","apiVersion","console","log","JSON","stringify","error","statusText","options","from","Math","ceil","parse","range","to","promises","map","targets","target","hide","group","device","channel","sensor","replace","getValues","timeseries","alias","datapoints","values","Promise","all","flatten","data","results","getMessages","annotation","sensorId","each","messages","query","match","reject","params","a","split","b","performPRTGAPIRequest","text","res","expandable"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from 'lodash';\r\nimport * as dateMath from 'app/core/utils/datemath';\r\nimport './PRTGAPIService';\r\n\r\nclass PRTGDataSource {\r\n    \r\n    /** @ngInject */\r\n    constructor(instanceSettings, templateSrv, alertSrv, PRTGAPIService) {\r\n        /**\r\n        * PRTG Datasource\r\n        * \r\n        * @param {object} Grafana Datasource Object\r\n        */\r\n        this.templateSrv = templateSrv;\r\n        this.alertServ = alertSrv;\r\n        \r\n        this.name =     instanceSettings.name;\r\n        this.url =      instanceSettings.url;\r\n        this.username = instanceSettings.jsonData.prtgApiUser;\r\n        this.passhash = instanceSettings.jsonData.prtgApiPasshash;\r\n        this.cacheTimeoutMintues = instanceSettings.jsonData.cacheTimeoutMinutes || 5;\r\n        this.limitmetrics = instanceSettings.meta.limitmetrics || 100;\r\n        this.prtgAPI = new PRTGAPIService(this.url, this.username, this.passhash, this.cacheTimeoutMintues);\r\n    }\r\n\r\n        /**\r\n         * Test the datasource\r\n         */\r\n        testDatasource() {\r\n            return this.prtgAPI.getVersion().then(apiVersion => {\r\n                return this.prtgAPI.performPRTGAPILogin()\r\n                    .then(() => {\r\n                        return {\r\n                            status: \"success\",\r\n                            title: \"Success\",\r\n                            message: \"PRTG API version: \" + apiVersion\r\n                        };\r\n                });\r\n            }, error => {\r\n                console.log(JSON.stringify(error,null,4));\r\n                return {\r\n                    status: \"error\",\r\n                    title: error.status + \": \" + error.statusText,\r\n                    message: \"\"//error.config.url\r\n                };\r\n            });\r\n        }\r\n    \r\n        \r\n        /**\r\n         * Data Source Query\r\n         * returns timeseries array of values\r\n         * \r\n         * @param {object} options; Dataset Options including targets, etc.\r\n         * @return [array]\r\n         */\r\n        query(options) {\r\n            var from = Math.ceil(dateMath.parse(options.range.from) / 1000);\r\n            var to = Math.ceil(dateMath.parse(options.range.to) / 1000);\r\n            var promises = _.map(options.targets, target => {\r\n                if (target.hide || !target.group || !target.device || !target.channel || !target.sensor) {\r\n                    return [];\r\n                }\r\n                \r\n                var device, group, sensor, channel = \"\";\r\n                group = this.templateSrv.replace(target.group.name);\r\n                device   = this.templateSrv.replace(target.device.name);\r\n                sensor   = this.templateSrv.replace(target.sensor.name);\r\n                channel  = this.templateSrv.replace(target.channel.name);\r\n\r\n                return this.prtgAPI.getValues(device, sensor, channel, from, to)\r\n                    .then(values => {                \r\n                        var timeseries = {target:target.alias, datapoints: values};\r\n                        return timeseries;\r\n                    });\r\n            });\r\n            \r\n            return Promise.all(_.flatten(promises))\r\n                .then(results => {\r\n                    return {data: results};\r\n                });\r\n        }\r\n        \r\n       annotationQuery (options) {\r\n            var from = Math.ceil(dateMath.parse(options.range.from) / 1000);\r\n            var to = Math.ceil(dateMath.parse(options.range.to) / 1000);\r\n            return this.prtgAPI.getMessages(from, to, options.annotation.sensorId)\r\n                .then(messages => {\r\n                    _.each(messages, message => {\r\n                        message.annotation = options.annotation; //inject the annotation into the object\r\n                    }, this);\r\n                return messages;\r\n            });\r\n        }\r\n\r\n        /* Find Metrics from templated letiables\r\n         *\r\n         * channel templates are limited to lookup by sensor's numeric ID.\r\n         *\r\n         * @param query Query string:\r\n         * channel:sensor=####\r\n         * sensor:device=$device or * or numeric ID\r\n         * device:group=$group or * or numeric ID\r\n         * group:* or name\r\n         */\r\n        metricFindQuery (query) {\r\n            if (!query.match(/(channel|sensor|device|group):(\\*)|(tags|sensor|device|group)=([\\$\\sa-zA-Z0-9-_]+)/i)) {\r\n                return Promise.reject(\"Syntax Error: Expected pattern matching /(sensors|devices|groups):(\\*)|(tags|device|group)=([a-zA-Z0-9]+)/i\");\r\n            }\r\n            var params = \"\";\r\n            var a = query.split(':');\r\n            if (a[0] == \"channel\") {\r\n                var b = a[1].split('=');\r\n                params = \"&content=channels&columns=name&id=\" + b[1];\r\n                a[0]=\"name\";\r\n            } else {\r\n                params=\"&content=\" + a[0] + \"s\";\r\n                if (a[1] !== '*') {\r\n                    params = params + \"&filter_\" + this.templateSrv.replace(a[1]);\r\n                }\r\n            }\r\n            return this.prtgAPI.performPRTGAPIRequest('table.json', params)\r\n                .then(results => {\r\n                    return _.map(results, res => {\r\n                        return {text: res[a[0]], expandable:0};\r\n                    }, this);\r\n            });\r\n            \r\n        }\r\n\r\n \r\n}\r\n\r\nexport { PRTGDataSource };\r\n\r\n"]}